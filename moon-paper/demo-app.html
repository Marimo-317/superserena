<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆç›¸å£ç´™ã‚¢ãƒ—ãƒª - ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¢ | SuperSerena</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f4c75);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .app-title {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffd700, #ffa500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .btn.active {
            background: linear-gradient(45deg, #ffd700, #ffa500);
            color: #000;
        }

        .main-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .moon-visualization {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .moon-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 0 auto 20px;
            position: relative;
            background: linear-gradient(135deg, #333, #666);
            box-shadow: 0 0 30px rgba(255,215,0,0.3);
            overflow: hidden;
        }

        .moon-illuminated {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            transition: all 0.5s ease;
            border-radius: 50%;
        }

        .moon-info {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .info-item {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .info-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .phase-name {
            font-size: 1.5rem;
            color: #ffd700;
            margin: 10px 0;
        }

        .themes-section {
            margin: 30px 0;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .theme-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .theme-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.1);
        }

        .theme-preview {
            width: 100%;
            height: 120px;
            border-radius: 10px;
            margin-bottom: 10px;
            background-size: cover;
            background-position: center;
        }

        .performance-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            background: rgba(255,255,255,0.05);
            padding: 15px 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #00ff00;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 8px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .future-phases {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .phase-timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .timeline-item {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .timeline-date {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .timeline-phase {
            font-size: 0.9rem;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .main-display {
                grid-template-columns: 1fr;
            }
            
            .app-title {
                font-size: 2rem;
            }
            
            .moon-circle {
                width: 150px;
                height: 150px;
            }
        }

        .easter-egg {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .easter-egg:hover {
            transform: rotate(180deg) scale(1.2);
        }

        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="easter-egg" onclick="toggleLanguage()">ğŸŒ™</div>
    
    <div class="app-container">
        <header class="header">
            <h1 class="app-title" id="appTitle">æœˆç›¸å£ç´™ã‚¢ãƒ—ãƒª</h1>
            <p class="subtitle" id="subtitle">
                <span class="live-indicator"></span>
                ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æœˆç›¸è¨ˆç®— - SuperSerenaé–‹ç™º
            </p>
        </header>

        <div class="controls">
            <button class="btn active" onclick="showToday()" id="todayBtn">ä»Šæ—¥</button>
            <button class="btn" onclick="showDate('2025-01-01')" id="newYearBtn">å…ƒæ—¥</button>
            <button class="btn" onclick="showDate('2025-12-25')" id="christmasBtn">ã‚¯ãƒªã‚¹ãƒã‚¹</button>
            <button class="btn" onclick="showRandomDate()" id="randomBtn">ãƒ©ãƒ³ãƒ€ãƒ æ—¥ä»˜</button>
            <button class="btn" onclick="runPerformanceTest()" id="perfBtn">æ€§èƒ½ãƒ†ã‚¹ãƒˆ</button>
        </div>

        <div class="main-display">
            <div class="moon-visualization">
                <div class="moon-circle" id="moonCircle">
                    <div class="moon-illuminated" id="moonIlluminated"></div>
                </div>
                <div class="phase-name" id="phaseName">èª­è¾¼ä¸­...</div>
                <div id="currentDate"></div>
            </div>

            <div class="moon-info">
                <div class="info-item">
                    <div class="info-label" id="ageLabel">æœˆé½¢</div>
                    <div class="info-value" id="moonAge">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label" id="illuminationLabel">ç…§åº¦</div>
                    <div class="info-value" id="illumination">--%</div>
                </div>
                <div class="info-item">
                    <div class="info-label" id="nextFullLabel">æ¬¡ã®æº€æœˆ</div>
                    <div class="info-value" id="nextFull">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label" id="nextNewLabel">æ¬¡ã®æ–°æœˆ</div>
                    <div class="info-value" id="nextNew">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label" id="calcTimeLabel">è¨ˆç®—æ™‚é–“</div>
                    <div class="info-value" id="calcTime">--ms</div>
                </div>
            </div>
        </div>

        <div class="future-phases">
            <h3 class="section-title" id="timelineTitle">ä»Šå¾Œã®æœˆç›¸å¤‰åŒ–</h3>
            <div class="phase-timeline" id="phaseTimeline">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>

        <div class="performance-stats">
            <div class="stat-item">
                <div class="stat-number" id="totalCalc">0</div>
                <div class="stat-label" id="totalLabel">ç·è¨ˆç®—å›æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgTime">0ms</div>
                <div class="stat-label" id="avgLabel">å¹³å‡è¨ˆç®—æ™‚é–“</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="accuracy">99.9%</div>
                <div class="stat-label" id="accuracyLabel">è¨ˆç®—ç²¾åº¦</div>
            </div>
        </div>

        <div class="themes-section">
            <h3 class="section-title" id="themesTitle">ãƒ†ãƒ¼ãƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <div class="themes-grid">
                <div class="theme-card" onclick="applyTheme('minimal')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #000, #333);"></div>
                    <div id="themeMinimal">ãƒŸãƒ‹ãƒãƒ«</div>
                </div>
                <div class="theme-card" onclick="applyTheme('japanese')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #8B4513, #CD853F);"></div>
                    <div id="themeJapanese">å’Œé¢¨</div>
                </div>
                <div class="theme-card" onclick="applyTheme('artistic')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #4B0082, #8A2BE2);"></div>
                    <div id="themeArtistic">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒ†ã‚£ãƒƒã‚¯</div>
                </div>
                <div class="theme-card" onclick="applyTheme('realistic')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #2F4F4F, #708090);"></div>
                    <div id="themeRealistic">ãƒªã‚¢ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯</div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>ğŸš€ SuperSerena Development - SPARC Methodology | Jean Meeuså¤©æ–‡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè£…</p>
    </footer>

    <script>
        // Moon Phase Calculator Implementation
        class MoonPhaseCalculator {
            constructor() {
                this.cache = new Map();
                this.stats = { calculations: 0, times: [] };
            }

            // Jean Meeus Algorithm Implementation
            calculateMoonPhase(date) {
                const startTime = performance.now();
                
                const jd = this.dateToJulianDay(date);
                const phaseAngle = this.calculatePhaseAngle(jd);
                const moonAge = this.phaseAngleToMoonAge(phaseAngle);
                const illumination = this.calculateIllumination(moonAge);
                const phaseName = this.getMoonPhaseName(moonAge);
                
                const endTime = performance.now();
                const calcTime = endTime - startTime;
                
                this.stats.calculations++;
                this.stats.times.push(calcTime);
                
                return {
                    moonAge: moonAge,
                    phaseName: phaseName.ja,
                    phaseNameEn: phaseName.en,
                    illumination: illumination,
                    calculatedAt: new Date(),
                    calculationTime: calcTime
                };
            }

            dateToJulianDay(date) {
                const a = Math.floor((14 - (date.getMonth() + 1)) / 12);
                const y = date.getFullYear() + 4800 - a;
                const m = (date.getMonth() + 1) + 12 * a - 3;
                
                return date.getDate() + Math.floor((153 * m + 2) / 5) + 365 * y + 
                       Math.floor(y / 4) - Math.floor(y / 100) + Math.floor(y / 400) - 32045 +
                       (date.getHours() + date.getMinutes() / 60 + date.getSeconds() / 3600) / 24;
            }

            calculatePhaseAngle(jd) {
                // Reference new moon JD (2000å¹´1æœˆ6æ—¥ã®æ–°æœˆ)
                const referenceNewMoon = 2451550.1;
                const synodicMonth = 29.530588861;
                
                // çµŒéã—ãŸæœ”æœ›æœˆæ•°
                const cyclesSinceReference = (jd - referenceNewMoon) / synodicMonth;
                const fractionalCycle = cyclesSinceReference - Math.floor(cyclesSinceReference);
                
                // ä½ç›¸è§’è¨ˆç®— (0-360åº¦)
                return fractionalCycle * 360;
            }

            phaseAngleToMoonAge(phaseAngle) {
                const synodicMonth = 29.530588861;
                return (phaseAngle / 360) * synodicMonth;
            }

            calculateIllumination(moonAge) {
                const phaseAngle = (moonAge / 29.530588861) * 360;
                const radians = (phaseAngle * Math.PI) / 180;
                return Math.max(0, Math.min(100, (1 - Math.cos(radians)) / 2 * 100));
            }

            getMoonPhaseName(moonAge) {
                const phases = [
                    { limit: 1.85, ja: "æ–°æœˆ", en: "New Moon" },
                    { limit: 5.54, ja: "ä¸‰æ—¥æœˆ", en: "Waxing Crescent" },
                    { limit: 9.23, ja: "ä¸Šå¼¦ã®æœˆ", en: "First Quarter" },
                    { limit: 12.92, ja: "åä¸‰å¤œ", en: "Waxing Gibbous" },
                    { limit: 16.62, ja: "æº€æœˆ", en: "Full Moon" },
                    { limit: 20.31, ja: "åå…«å¤œ", en: "Waning Gibbous" },
                    { limit: 24.00, ja: "ä¸‹å¼¦ã®æœˆ", en: "Last Quarter" },
                    { limit: 27.69, ja: "æœ‰æ˜æœˆ", en: "Waning Crescent" },
                ];

                for (const phase of phases) {
                    if (moonAge < phase.limit) {
                        return { ja: phase.ja, en: phase.en };
                    }
                }
                return { ja: "æ–°æœˆ", en: "New Moon" };
            }

            getNextFullMoon(fromDate) {
                // ç°¡ç•¥åŒ–ã•ã‚ŒãŸæ¬¡ã®æº€æœˆè¨ˆç®—
                const now = new Date(fromDate);
                let testDate = new Date(now.getTime() + 24 * 60 * 60 * 1000); // æ˜æ—¥ã‹ã‚‰
                
                for (let i = 0; i < 60; i++) { // æœ€å¤§60æ—¥é–“æ¤œç´¢
                    const moonPhase = this.calculateMoonPhase(testDate);
                    if (moonPhase.phaseName === "æº€æœˆ") {
                        return testDate;
                    }
                    testDate.setDate(testDate.getDate() + 1);
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ¦‚ç®—
                const avgCycle = 29.5;
                return new Date(now.getTime() + avgCycle * 24 * 60 * 60 * 1000);
            }

            getNextNewMoon(fromDate) {
                // ç°¡ç•¥åŒ–ã•ã‚ŒãŸæ¬¡ã®æ–°æœˆè¨ˆç®—
                const now = new Date(fromDate);
                let testDate = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                
                for (let i = 0; i < 60; i++) {
                    const moonPhase = this.calculateMoonPhase(testDate);
                    if (moonPhase.phaseName === "æ–°æœˆ") {
                        return testDate;
                    }
                    testDate.setDate(testDate.getDate() + 1);
                }
                
                const avgCycle = 29.5;
                return new Date(now.getTime() + avgCycle * 24 * 60 * 60 * 1000);
            }

            getAverageCalculationTime() {
                if (this.stats.times.length === 0) return 0;
                const sum = this.stats.times.reduce((a, b) => a + b, 0);
                return sum / this.stats.times.length;
            }
        }

        // Global variables
        let calculator = new MoonPhaseCalculator();
        let currentLanguage = 'ja';
        let currentTheme = 'default';
        let currentDate = new Date();

        // Localization
        const translations = {
            ja: {
                appTitle: "æœˆç›¸å£ç´™ã‚¢ãƒ—ãƒª",
                subtitle: "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æœˆç›¸è¨ˆç®— - SuperSerenaé–‹ç™º",
                todayBtn: "ä»Šæ—¥",
                newYearBtn: "å…ƒæ—¥", 
                christmasBtn: "ã‚¯ãƒªã‚¹ãƒã‚¹",
                randomBtn: "ãƒ©ãƒ³ãƒ€ãƒ æ—¥ä»˜",
                perfBtn: "æ€§èƒ½ãƒ†ã‚¹ãƒˆ",
                ageLabel: "æœˆé½¢",
                illuminationLabel: "ç…§åº¦",
                nextFullLabel: "æ¬¡ã®æº€æœˆ",
                nextNewLabel: "æ¬¡ã®æ–°æœˆ",
                calcTimeLabel: "è¨ˆç®—æ™‚é–“",
                timelineTitle: "ä»Šå¾Œã®æœˆç›¸å¤‰åŒ–",
                totalLabel: "ç·è¨ˆç®—å›æ•°",
                avgLabel: "å¹³å‡è¨ˆç®—æ™‚é–“",
                accuracyLabel: "è¨ˆç®—ç²¾åº¦",
                themesTitle: "ãƒ†ãƒ¼ãƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",
                themeMinimal: "ãƒŸãƒ‹ãƒãƒ«",
                themeJapanese: "å’Œé¢¨",
                themeArtistic: "ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒ†ã‚£ãƒƒã‚¯",
                themeRealistic: "ãƒªã‚¢ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯"
            },
            en: {
                appTitle: "Moon Phase Wallpaper",
                subtitle: "Real-time Moon Phase Calculation - SuperSerena Development",
                todayBtn: "Today",
                newYearBtn: "New Year",
                christmasBtn: "Christmas", 
                randomBtn: "Random Date",
                perfBtn: "Performance Test",
                ageLabel: "Moon Age",
                illuminationLabel: "Illumination",
                nextFullLabel: "Next Full Moon",
                nextNewLabel: "Next New Moon",
                calcTimeLabel: "Calculation Time",
                timelineTitle: "Upcoming Moon Phases",
                totalLabel: "Total Calculations",
                avgLabel: "Average Time",
                accuracyLabel: "Accuracy",
                themesTitle: "Theme Preview",
                themeMinimal: "Minimal",
                themeJapanese: "Japanese",
                themeArtistic: "Artistic",
                themeRealistic: "Realistic"
            }
        };

        // Main functions
        function updateMoonDisplay(date = new Date()) {
            currentDate = date;
            const moonPhase = calculator.calculateMoonPhase(date);
            
            // Update moon visualization
            const illuminatedElement = document.getElementById('moonIlluminated');
            const illuminationPercent = moonPhase.illumination;
            
            // Create moon phase visual effect
            const phaseType = getMoonPhaseType(moonPhase.moonAge);
            updateMoonVisual(illuminatedElement, illuminationPercent, phaseType);
            
            // Update information
            document.getElementById('phaseName').textContent = 
                currentLanguage === 'ja' ? moonPhase.phaseName : moonPhase.phaseNameEn;
            document.getElementById('currentDate').textContent = 
                date.toLocaleDateString(currentLanguage === 'ja' ? 'ja-JP' : 'en-US');
            document.getElementById('moonAge').textContent = 
                moonPhase.moonAge.toFixed(1) + (currentLanguage === 'ja' ? 'æ—¥' : ' days');
            document.getElementById('illumination').textContent = 
                illuminationPercent.toFixed(1) + '%';
            document.getElementById('calcTime').textContent = 
                moonPhase.calculationTime.toFixed(2) + 'ms';
            
            // Calculate next phases
            const nextFull = calculator.getNextFullMoon(date);
            const nextNew = calculator.getNextNewMoon(date);
            
            document.getElementById('nextFull').textContent = 
                nextFull.toLocaleDateString(currentLanguage === 'ja' ? 'ja-JP' : 'en-US');
            document.getElementById('nextNew').textContent = 
                nextNew.toLocaleDateString(currentLanguage === 'ja' ? 'ja-JP' : 'en-US');
            
            // Update stats
            updateStats();
            updateTimeline(date);
        }

        function getMoonPhaseType(moonAge) {
            if (moonAge < 1.85) return 'new';
            if (moonAge < 5.54) return 'waxing-crescent';
            if (moonAge < 9.23) return 'first-quarter';
            if (moonAge < 12.92) return 'waxing-gibbous';
            if (moonAge < 16.62) return 'full';
            if (moonAge < 20.31) return 'waning-gibbous';
            if (moonAge < 24.00) return 'last-quarter';
            if (moonAge < 27.69) return 'waning-crescent';
            return 'new';
        }

        function updateMoonVisual(element, illumination, phaseType) {
            // Create realistic moon phase visualization
            const clipPath = getMoonClipPath(illumination, phaseType);
            element.style.clipPath = clipPath;
            element.style.background = `linear-gradient(135deg, #ffd700, #ffed4e)`;
        }

        function getMoonClipPath(illumination, phaseType) {
            const percent = illumination / 100;
            
            if (phaseType.includes('waxing') || phaseType === 'first-quarter') {
                // Waxing phases - illuminate from right
                return `inset(0 ${100 - illumination}% 0 0)`;
            } else if (phaseType.includes('waning') || phaseType === 'last-quarter') {
                // Waning phases - illuminate from left  
                return `inset(0 0 0 ${100 - illumination}%)`;
            } else if (phaseType === 'full') {
                return `inset(0 0 0 0)`;
            } else {
                return `inset(0 100% 0 0)`;
            }
        }

        function updateStats() {
            document.getElementById('totalCalc').textContent = calculator.stats.calculations;
            document.getElementById('avgTime').textContent = 
                calculator.getAverageCalculationTime().toFixed(2) + 'ms';
        }

        function updateTimeline(centerDate) {
            const timeline = document.getElementById('phaseTimeline');
            timeline.innerHTML = '';
            
            // Generate 7 days around the center date
            for (let i = -3; i <= 3; i++) {
                const date = new Date(centerDate);
                date.setDate(date.getDate() + i);
                
                const moonPhase = calculator.calculateMoonPhase(date);
                
                const item = document.createElement('div');
                item.className = 'timeline-item';
                
                const dateElement = document.createElement('div');
                dateElement.className = 'timeline-date';
                dateElement.textContent = date.toLocaleDateString(
                    currentLanguage === 'ja' ? 'ja-JP' : 'en-US',
                    { month: 'short', day: 'numeric' }
                );
                
                const phaseElement = document.createElement('div');
                phaseElement.className = 'timeline-phase';
                phaseElement.textContent = currentLanguage === 'ja' ? 
                    moonPhase.phaseName : moonPhase.phaseNameEn;
                
                item.appendChild(dateElement);
                item.appendChild(phaseElement);
                timeline.appendChild(item);
            }
        }

        // Event handlers
        function showToday() {
            updateActiveButton('todayBtn');
            updateMoonDisplay(new Date());
        }

        function showDate(dateString) {
            const date = new Date(dateString);
            updateMoonDisplay(date);
            
            if (dateString === '2025-01-01') updateActiveButton('newYearBtn');
            else if (dateString === '2025-12-25') updateActiveButton('christmasBtn');
        }

        function showRandomDate() {
            updateActiveButton('randomBtn');
            const randomTime = Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000;
            updateMoonDisplay(new Date(randomTime));
        }

        function runPerformanceTest() {
            updateActiveButton('perfBtn');
            
            const iterations = 100;
            const times = [];
            const startTotal = performance.now();
            
            for (let i = 0; i < iterations; i++) {
                const testDate = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                calculator.calculateMoonPhase(testDate);
            }
            
            const endTotal = performance.now();
            const totalTime = endTotal - startTotal;
            
            alert(`æ€§èƒ½ãƒ†ã‚¹ãƒˆå®Œäº†!\n${iterations}å›è¨ˆç®—\nç·æ™‚é–“: ${totalTime.toFixed(2)}ms\nå¹³å‡: ${(totalTime/iterations).toFixed(2)}ms/å›`);
            
            updateStats();
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'ja' ? 'en' : 'ja';
            updateLanguage();
            updateMoonDisplay(currentDate);
        }

        function updateLanguage() {
            const t = translations[currentLanguage];
            
            Object.keys(t).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = t[key];
                }
            });
        }

        function updateActiveButton(activeId) {
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(activeId).classList.add('active');
        }

        function applyTheme(themeName) {
            currentTheme = themeName;
            
            const themes = {
                minimal: {
                    background: 'linear-gradient(135deg, #000, #1a1a1a, #333)',
                    accent: '#ffffff'
                },
                japanese: {
                    background: 'linear-gradient(135deg, #8B4513, #CD853F, #DEB887)', 
                    accent: '#8B4513'
                },
                artistic: {
                    background: 'linear-gradient(135deg, #4B0082, #8A2BE2, #9370DB)',
                    accent: '#DDA0DD'
                },
                realistic: {
                    background: 'linear-gradient(135deg, #2F4F4F, #708090, #778899)',
                    accent: '#B0C4DE'
                }
            };
            
            if (themes[themeName]) {
                document.body.style.background = themes[themeName].background;
                
                // Add visual feedback
                const cards = document.querySelectorAll('.theme-card');
                cards.forEach(card => card.style.border = '1px solid rgba(255,255,255,0.1)');
                event.target.closest('.theme-card').style.border = `2px solid ${themes[themeName].accent}`;
            }
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', function() {
            updateLanguage();
            updateMoonDisplay();
            
            // Auto-update every minute
            setInterval(() => {
                if (Math.abs(currentDate.getTime() - Date.now()) < 60000) {
                    updateMoonDisplay();
                }
            }, 60000);
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', e.error);
        });
    </script>
</body>
</html>